{"version":3,"file":"mockActionContext.cjs.js","sources":["../../src/actions/mockActionContext.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { PassThrough } from 'stream';\nimport {\n  createMockDirectory,\n  mockCredentials,\n  mockServices,\n} from '@backstage/backend-test-utils';\nimport { JsonObject, JsonValue } from '@backstage/types';\nimport { ActionContext } from '@backstage/plugin-scaffolder-node';\nimport { loggerToWinstonLogger } from './loggerToWinstonLogger';\n\n/**\n * A utility method to create a mock action context for scaffolder actions.\n *\n * @public\n * @param options - optional parameters to override default mock context\n */\nexport const createMockActionContext = <\n  TActionInput extends JsonObject = JsonObject,\n  TActionOutput extends JsonObject = JsonObject,\n>(\n  options?: Partial<ActionContext<TActionInput, TActionOutput>>,\n): ActionContext<TActionInput, TActionOutput> => {\n  const credentials = mockCredentials.user();\n  const defaultContext = {\n    logger: loggerToWinstonLogger(mockServices.logger.mock()),\n    logStream: new PassThrough(),\n    output: jest.fn(),\n    createTemporaryDirectory: jest.fn(),\n    input: {} as TActionInput,\n    async checkpoint<T extends JsonValue | void>(opts: {\n      key: string;\n      fn: () => Promise<T> | T;\n    }): Promise<T> {\n      return opts.fn();\n    },\n    getInitiatorCredentials: () => Promise.resolve(credentials),\n    task: {\n      id: 'mock-task-id',\n    },\n  };\n\n  const createDefaultWorkspace = () => ({\n    workspacePath: createMockDirectory().resolve('workspace'),\n  });\n\n  if (!options) {\n    return {\n      ...defaultContext,\n      ...createDefaultWorkspace(),\n    };\n  }\n\n  const {\n    input,\n    logger,\n    logStream,\n    secrets,\n    templateInfo,\n    workspacePath,\n    task,\n  } = options;\n\n  return {\n    ...defaultContext,\n    ...(workspacePath ? { workspacePath } : createDefaultWorkspace()),\n    ...(workspacePath && {\n      createTemporaryDirectory: jest.fn().mockResolvedValue(workspacePath),\n    }),\n    ...(logger && { logger }),\n    ...(logStream && { logStream }),\n    ...(input && { input }),\n    ...(secrets && { secrets }),\n    ...(task && { task }),\n    templateInfo,\n  };\n};\n"],"names":["mockCredentials","loggerToWinstonLogger","mockServices","PassThrough","createMockDirectory"],"mappings":";;;;;;AAgCa,MAAA,uBAAA,GAA0B,CAIrC,OAC+C,KAAA;AAC/C,EAAM,MAAA,WAAA,GAAcA,iCAAgB,IAAK,EAAA;AACzC,EAAA,MAAM,cAAiB,GAAA;AAAA,IACrB,MAAQ,EAAAC,2CAAA,CAAsBC,6BAAa,CAAA,MAAA,CAAO,MAAM,CAAA;AAAA,IACxD,SAAA,EAAW,IAAIC,kBAAY,EAAA;AAAA,IAC3B,MAAA,EAAQ,KAAK,EAAG,EAAA;AAAA,IAChB,wBAAA,EAA0B,KAAK,EAAG,EAAA;AAAA,IAClC,OAAO,EAAC;AAAA,IACR,MAAM,WAAuC,IAG9B,EAAA;AACb,MAAA,OAAO,KAAK,EAAG,EAAA;AAAA,KACjB;AAAA,IACA,uBAAyB,EAAA,MAAM,OAAQ,CAAA,OAAA,CAAQ,WAAW,CAAA;AAAA,IAC1D,IAAM,EAAA;AAAA,MACJ,EAAI,EAAA;AAAA;AACN,GACF;AAEA,EAAA,MAAM,yBAAyB,OAAO;AAAA,IACpC,aAAe,EAAAC,oCAAA,EAAsB,CAAA,OAAA,CAAQ,WAAW;AAAA,GAC1D,CAAA;AAEA,EAAA,IAAI,CAAC,OAAS,EAAA;AACZ,IAAO,OAAA;AAAA,MACL,GAAG,cAAA;AAAA,MACH,GAAG,sBAAuB;AAAA,KAC5B;AAAA;AAGF,EAAM,MAAA;AAAA,IACJ,KAAA;AAAA,IACA,MAAA;AAAA,IACA,SAAA;AAAA,IACA,OAAA;AAAA,IACA,YAAA;AAAA,IACA,aAAA;AAAA,IACA;AAAA,GACE,GAAA,OAAA;AAEJ,EAAO,OAAA;AAAA,IACL,GAAG,cAAA;AAAA,IACH,GAAI,aAAA,GAAgB,EAAE,aAAA,KAAkB,sBAAuB,EAAA;AAAA,IAC/D,GAAI,aAAiB,IAAA;AAAA,MACnB,wBAA0B,EAAA,IAAA,CAAK,EAAG,EAAA,CAAE,kBAAkB,aAAa;AAAA,KACrE;AAAA,IACA,GAAI,MAAU,IAAA,EAAE,MAAO,EAAA;AAAA,IACvB,GAAI,SAAa,IAAA,EAAE,SAAU,EAAA;AAAA,IAC7B,GAAI,KAAS,IAAA,EAAE,KAAM,EAAA;AAAA,IACrB,GAAI,OAAW,IAAA,EAAE,OAAQ,EAAA;AAAA,IACzB,GAAI,IAAQ,IAAA,EAAE,IAAK,EAAA;AAAA,IACnB;AAAA,GACF;AACF;;;;"}